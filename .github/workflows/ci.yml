name: CI

on:
  push:
    branches:
      - main
  pull_request:
    # Run CI on PRs targeting any branch

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0

jobs:
  # Call all reusable workflows
  check:
    name: Check
    uses: ./.github/workflows/check.yml

  fmt:
    name: Format
    uses: ./.github/workflows/fmt.yml

  clippy:
    name: Clippy
    uses: ./.github/workflows/clippy.yml

  # Phase 1: Unit tests run first to verify basic functionality
  unit-test:
    name: Unit Tests
    uses: ./.github/workflows/unit-test.yml
    needs: [check, fmt, clippy]  # Run after lightweight checks

  # Phase 2: Parallel execution group - tests run simultaneously on independent runners
  # Note: Each job runs on its own runner (no shared disk)
  # Integration tests are split into intra-crate and cross-crate to reduce disk usage per job
  intra-crate-integration-test:
    name: Intra-Crate Integration Tests
    uses: ./.github/workflows/intra-crate-integration-test.yml
    needs: [unit-test]

  cross-crate-integration-test:
    name: Cross-Crate Integration Tests
    uses: ./.github/workflows/cross-crate-integration-test.yml
    needs: [unit-test]

  doc-test:
    name: Documentation Tests
    uses: ./.github/workflows/doc-test.yml
    needs: [unit-test]  # Run in parallel with integration tests

  ui-test:
    name: UI Tests
    uses: ./.github/workflows/ui-test.yml
    needs: [unit-test]  # Run in parallel with integration tests and doc-test

  # Phase 3: Examples tests run last (requires 70-90GB, must run alone)
  examples-test:
    name: Examples Tests
    uses: ./.github/workflows/examples-test.yml
    needs: [intra-crate-integration-test, cross-crate-integration-test, doc-test, ui-test]  # Wait for all parallel tests to complete

  # All jobs must pass
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - check
      - fmt
      - clippy
      - unit-test
      - intra-crate-integration-test
      - cross-crate-integration-test
      - doc-test
      - examples-test
      - ui-test
    steps:
      - name: Mark CI as successful
        run: echo "All CI checks passed!"
