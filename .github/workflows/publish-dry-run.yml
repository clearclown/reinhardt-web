name: Publish Dry-Run

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, labeled]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  dry-run:
    name: Dry-run publish check
    runs-on: ubuntu-latest
    # Only run for PRs with 'release' label
    if: contains(github.event.pull_request.labels.*.name, 'release')

    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for cargo-workspaces

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@1.91.1

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Clean cargo cache
        run: cargo clean

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-workspaces
        run: cargo install cargo-workspaces

      - name: Detect changed crates
        id: detect-crates
        run: |
          echo "Detecting changed crates..."

          # Use cargo-workspaces to detect changed crates
          CHANGED_OUTPUT=$(cargo ws changed 2>&1 || true)

          if echo "$CHANGED_OUTPUT" | grep -q "No changed crates detected"; then
            echo "No changed crates detected."
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "::notice::No crates need publishing"
            exit 0
          fi

          echo "Changed crates found:"
          echo "$CHANGED_OUTPUT"
          echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Run dry-run publish for changed crates
        if: steps.detect-crates.outputs.has_changes == 'true'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          echo "::group::Running dry-run publish for changed crates"

          # cargo-workspaces automatically detects changed crates
          # and publishes them in dependency order
          if cargo ws publish --dry-run; then
            echo "âœ… Dry-run passed for all changed crates"
            echo "::notice::All dry-run checks passed successfully"
          else
            echo "âŒ Dry-run failed"
            echo "::error::Dry-run publish failed. Check logs above for details."
            exit 1
          fi

          echo "::endgroup::"

      - name: Summary
        if: always() && steps.detect-crates.outputs.has_changes == 'true'
        run: |
          {
            echo "## ðŸ“‹ Dry-Run Publish Check"
            echo ""
            echo "cargo-workspaces validated all changed crates for publishing."
            echo ""
            echo "### Next Steps"
            echo ""
            echo "If all checks passed, this PR is ready to merge."
            echo "Upon merge, the 'publish-on-merge' workflow will:"
            echo "1. Publish changed crates to crates.io in dependency order"
            echo "2. Create GitHub Releases"
            echo "3. Push release tags"
          } >> $GITHUB_STEP_SUMMARY

      - name: No changes summary
        if: always() && steps.detect-crates.outputs.has_changes == 'false'
        run: |
          {
            echo "## â„¹ï¸ No Crates to Publish"
            echo ""
            echo "No crates have changed since the last release."
            echo ""
            echo "**Note:** This PR has the \`release\` label but no crates need publishing."
            echo "Consider removing the \`release\` label if this is not a release PR."
          } >> $GITHUB_STEP_SUMMARY
