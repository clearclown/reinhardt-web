# Bacon configuration for Reinhardt
# https://dystroy.org/bacon/

# Default job to run when `bacon` is called without arguments
default_job = "check"

# ============================================================================
# Core Development Jobs
# ============================================================================

[jobs.check]
command = [
	"cargo",
	"check",
	"--workspace",
	"--all",
	"--all-features",
	"--all-targets",
	"--tests",
	"--quiet",
]
need_stdout = false
watch = ["src/**", "crates/**/src/**", "Cargo.toml", "crates/**/Cargo.toml"]

[jobs.clippy]
command = [
	"cargo",
	"clippy",
	"--workspace",
	"--all",
	"--all-features",
	"--",
	"-D",
	"warnings",
]
need_stdout = false
watch = ["src/**", "crates/**/src/**", "Cargo.toml", "crates/**/Cargo.toml"]

[jobs.test]
command = [
	"cargo",
	"nextest",
	"run",
	"--workspace",
	"--all-features",
	"--no-fail-fast",
]
need_stdout = true
watch = [
	"src/**",
	"crates/**/src/**",
	"tests/**",
	"crates/**/tests/**",
	"Cargo.toml",
	"crates/**/Cargo.toml",
]

[jobs.doc-test]
command = [
	"cargo",
	"test",
	"--workspace",
	"--doc",
	"--all-features",
	"--no-fail-fast",
]
need_stdout = true
watch = ["src/**", "crates/**/src/**", "Cargo.toml", "crates/**/Cargo.toml"]

# ============================================================================
# Development Server Jobs
# ============================================================================

[jobs.runserver]
command = ["cargo", "run", "--bin", "manage", "runserver"]
need_stdout = true
watch = ["src/**", "Cargo.toml"]

# ============================================================================
# Example Project Jobs
# ============================================================================

[jobs.runserver-twitter]
command = [
	"cargo",
	"run",
	"--manifest-path",
	"examples/local/examples-twitter/Cargo.toml",
	"--bin",
	"manage",
	"runserver",
]
need_stdout = true
watch = [
	"examples/local/examples-twitter/src/**",
	"examples/local/examples-twitter/Cargo.toml",
]

# ============================================================================
# Code Quality Jobs
# ============================================================================

[jobs.fmt-check]
command = ["cargo", "fmt", "--check", "--all"]
need_stdout = false
watch = ["src/**", "crates/**/src/**"]

[jobs.build]
command = [
	"cargo",
	"build",
	"--workspace",
	"--all",
	"--all-features",
	"--all-targets",
	"--quiet",
]
need_stdout = false
watch = ["src/**", "crates/**/src/**", "Cargo.toml", "crates/**/Cargo.toml"]

# ============================================================================
# LSP Integration Jobs (bacon-ls)
# ============================================================================

[jobs.bacon-ls]
command = [
	"cargo",
	"clippy",
	"--workspace",
	"--all-targets",
	"--all-features",
	"--message-format",
	"json-diagnostic-rendered-ansi",
]
analyzer = "cargo_json"
need_stdout = true
watch = ["src/**", "crates/**/src/**", "Cargo.toml", "crates/**/Cargo.toml"]

[exports.cargo-json-spans]
auto = true
exporter = "analyzer"
line_format = """\
  {diagnostic.level}|:|{span.file_name}|:|{span.line_start}|:|{span.line_end}|:|\
  {span.column_start}|:|{span.column_end}|:|{diagnostic.message}|:|{diagnostic.rendered}|:|\
  {span.suggested_replacement}\
"""
path = ".bacon-locations"
