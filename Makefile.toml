# Reinhardt - cargo-make configuration

[config]
default_to_workspace = false

# Environment variables
[env]
CARGO_TERM_COLOR = "always"
RUST_BACKTRACE = "1"
TEST_DATABASE_URL = "postgres://postgres:postgres@localhost:5432/test_db"
MYSQL_DATABASE_URL = "mysql://root:mysql@localhost:3306/test_db"
REDIS_URL = "redis://localhost:6379"
# Force TestContainers to use Docker instead of Podman
DOCKER_HOST = "unix:///var/run/docker.sock"
TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE = "/var/run/docker.sock"

# ============================================================================
# Core Development Tasks
# ============================================================================

[tasks.check]
description = "Run cargo check on workspace"
command = "cargo"
args = [
  "check",
  "--workspace",
  "--all",
  "--all-features",
  "--all-targets",
  "--tests",
  "--benches",
  "--examples",
  "--quiet"
]

[tasks.build]
description = "Build workspace"
command = "cargo"
args = ["build", "--workspace", "--all", "--all-features", "--all-targets", "--quiet"]

[tasks.build-release]
description = "Build workspace in release mode"
command = "cargo"
args = ["build", "--workspace", "--all", "--all-features", "--release", "--quiet"]

[tasks.clean]
description = "Clean build artifacts"
command = "cargo"
args = ["clean"]

# ============================================================================
# Code Quality Tasks
# ============================================================================

[tasks.fmt-check]
description = "Check code formatting (CI mode)"
command = "cargo"
args = ["fmt", "--check", "--all"]

[tasks.fmt-fix]
description = "Auto-fix code formatting"
command = "cargo"
args = ["fmt", "--all"]

[tasks.clippy-check]
description = "Run clippy linter"
command = "cargo"
args = [
  "clippy",
  "--workspace",
  "--all",
  "--all-features",
  "--",
  "-D",
  "warnings",
]

[tasks.clippy-fix]
description = "Run clippy linter and automatically fix found errors."
command = "cargo"
args = [
  "clippy",
  "--fix",
  "--workspace",
  "--all",
  "--all-features",
  "--allow-dirty",
  "--",
  "-D",
  "warnings",
]

[tasks.fmt-page]
description = "Format page! macro DSL in source files"
command = "cargo"
args = ["run", "-p", "reinhardt-admin-cli", "--", "fmt", "."]

[tasks.fmt-page-check]
description = "Check page! macro DSL formatting (CI mode)"
command = "cargo"
args = ["run", "-p", "reinhardt-admin-cli", "--", "fmt", "--check", "."]

[tasks.auto-fix]
description = "Run all auto-fixes"
dependencies = ["fmt-fix", "clippy-fix", "fmt-page"]

# ============================================================================
# Testing Tasks
# ============================================================================

[tasks.doc-test]
description = "Run only documentation tests"
command = "cargo"
args = ["test", "--workspace", "--doc", "--quiet", "--all-features", "--no-fail-fast"]

[tasks.bench]
description = "Run benchmark tests in tests/bench"
command = "cargo"
args = ["bench", "--manifest-path", "tests/bench/Cargo.toml"]

[tasks.unit-test]
description = "Run unit tests (src/)"
command = "cargo"
args = [
  "nextest",
  "run",
  "--workspace",
  "--lib",
  "--exclude",
  "reinhardt-integration-tests",
  "--all-features",
  "--no-fail-fast",
  "--show-progress=none",
  "--status-level=none",
  "--final-status-level=none",
]

[tasks.intra-crate-integration-test]
description = "Run intra-crate integration tests (tests/)"
command = "cargo"
args = [
  "nextest",
  "run",
  "--workspace",
  "--test",
  "*",
  "--exclude",
  "reinhardt-integration-tests",
  "--all-features",
  "--no-fail-fast",
  "--show-progress=none",
  "--status-level=none",
  "--final-status-level=none"
]

[tasks.cross-crate-integration-test]
description = "Run cross-crate integration tests (reinhardt-integration-tests)"
command = "cargo"
args = [
  "nextest",
  "run",
  "--package",
  "reinhardt-integration-tests",
  "--all-features",
  "--no-fail-fast",
  "--show-progress=none",
  "--status-level=none",
  "--final-status-level=none"
]

[tasks.integration-test]
description = "Run all integration tests"
dependencies = ["intra-crate-integration-test", "cross-crate-integration-test"]

[tasks.local-examples-test]
description = "Test local examples (now part of workspace)"
command = "cargo"
args = [
  "nextest",
  "run",
  "-p", "examples-hello-world",
  "-p", "examples-rest-api",
  "-p", "examples-database-integration",
  "-p", "examples-tutorial-basis",
  "-p", "examples-tutorial-rest",
  "-p", "examples-twitter",
  "-p", "examples-github-issues",
  "--verbose"
]

[tasks.remote-examples-test]
description = "Test remote examples (uses crates.io published versions)"
cwd = "examples/remote"
command = "cargo"
args = ["nextest", "run", "--workspace", "--verbose"]

[tasks.examples-test]
description = "Test all examples (local + remote)"
dependencies = ["local-examples-test", "remote-examples-test"]

[tasks.test]
description = "Run all tests"
dependencies = [
  "unit-test",
  "integration-test",
  "doc-test",
  "examples-test",
]

# ============================================================================
# CI Tasks
# ============================================================================

[tasks.ci]
description = "Run all CI checks (check, fmt, clippy, examples-build, tests)"
dependencies = ["check", "fmt-check", "clippy-check", "fmt-page-check", "examples-build", "test"]

# ============================================================================
# Documentation Tasks
# ============================================================================

[tasks.doc]
description = "Build documentation"
command = "cargo"
args = ["doc", "--workspace", "--all-features", "--no-deps"]

[tasks.doc-open]
description = "Build and open documentation"
command = "cargo"
args = ["doc", "--workspace", "--all-features", "--no-deps", "--open"]

# ============================================================================
# Utility Tasks
# ============================================================================

[tasks.outdated]
description = "Check for outdated dependencies"
command = "cargo"
args = ["outdated"]

[tasks.update]
description = "Update dependencies"
command = "cargo"
args = ["update"]

[tasks.tree]
description = "Display dependency tree"
command = "cargo"
args = ["tree", "--workspace"]

[tasks.bloat]
description = "Analyze binary bloat"
command = "cargo"
args = ["bloat", "--release"]

# ============================================================================
# Helper Tasks
# ============================================================================

[tasks.default]
description = "Default task - shows help"
command = "cargo"
args = ["make", "--list-all-steps"]

[tasks.help]
description = "Show available tasks"
command = "cargo"
args = ["make", "--list-all-steps"]

# ============================================================================
# Watch Tasks (using bacon)
# ============================================================================

[tasks.watch]
description = "Watch for changes and run checks (requires bacon)"
command = "bacon"
dependencies = ["install-bacon"]

[tasks.watch-test]
description = "Watch for changes and run tests (requires bacon)"
command = "bacon"
args = ["test"]
dependencies = ["install-bacon"]

[tasks.watch-clippy]
description = "Watch for changes and run clippy (requires bacon)"
command = "bacon"
args = ["clippy"]
dependencies = ["install-bacon"]

[tasks.install-bacon]
description = "Install bacon if not already installed"
script = '''
if ! command -v bacon &> /dev/null
then
	echo "Installing bacon..."
	cargo install --locked bacon
else
	echo "bacon is already installed"
fi
'''

# ============================================================================
# Examples Tasks
# ============================================================================

[tasks.local-examples-build]
description = "Build local examples (now part of workspace)"
command = "cargo"
args = [
  "build",
  "-p", "examples-hello-world",
  "-p", "examples-rest-api",
  "-p", "examples-database-integration",
  "-p", "examples-tutorial-basis",
  "-p", "examples-tutorial-rest",
  "-p", "examples-twitter",
  "-p", "examples-github-issues",
  "--release"
]

[tasks.remote-examples-build]
description = "Build remote examples individually (auto-detect examples-* directories)"
script = '''
#!/bin/bash

# Change to examples/remote directory
cd examples/remote

EXIT_CODE=0

# Find all directories starting with "examples-"
for example_dir in examples-*; do
  if [ -d "$example_dir" ]; then
    example_name=$(basename "$example_dir")
    echo ""
    echo "========================================"
    echo "Building $example_name..."
    echo "========================================"

    # Build and capture output to temporary file
    BUILD_LOG=$(mktemp)

    # Run build and capture both output and exit status
    # Use PIPESTATUS to get cargo's exit code (not tee's)
    (cd "$example_dir" && cargo build --release 2>&1 | tee "$BUILD_LOG"; exit ${PIPESTATUS[0]})
    BUILD_STATUS=$?

    if [ $BUILD_STATUS -eq 0 ]; then
      # Build succeeded
      echo "âœ… $example_name built successfully"
      rm -f "$BUILD_LOG"
    else
      # Build failed - check if it's a version/dependency issue
      if grep -qE "failed to select a version|does not have that feature|no matching version|could not be found" "$BUILD_LOG"; then
        # Version/dependency issue - skip
        echo "â­ï¸  Skipping $example_name (dependency version mismatch)"
      else
        # Other error - treat as actual build failure
        echo "âŒ Build failed: $example_name"
        echo "Last 30 lines of error:"
        tail -n 30 "$BUILD_LOG"
        EXIT_CODE=1
      fi
      rm -f "$BUILD_LOG"
    fi
  fi
done

exit $EXIT_CODE
'''

[tasks.examples-build]
description = "Build all examples (local + remote)"
dependencies = ["local-examples-build", "remote-examples-build"]

[tasks.local-examples-clean]
description = "Clean local examples build artifacts (now part of workspace clean)"
command = "cargo"
args = [
  "clean",
  "-p", "examples-hello-world",
  "-p", "examples-rest-api",
  "-p", "examples-database-integration",
  "-p", "examples-tutorial-basis",
  "-p", "examples-tutorial-rest",
  "-p", "examples-twitter",
  "-p", "examples-github-issues"
]

[tasks.remote-examples-clean]
description = "Clean remote examples build artifacts"
cwd = "examples/remote"
command = "cargo"
args = ["clean"]

[tasks.examples-clean]
description = "Clean all examples build artifacts"
dependencies = ["local-examples-clean", "remote-examples-clean"]

# ============================================================================
# Combined CI Tasks (including examples)
# ============================================================================

[tasks.ci-full]
description = "Run all CI checks including examples tests"
dependencies = ["check", "fmt", "clippy", "test", "examples-test"]

[tasks.ci-with-examples]
description = "Alias for ci-full"
dependencies = ["ci-full"]

# ============================================================================
# WASM Build Tasks
# ============================================================================

[tasks.install-wasm-tools]
description = "Install WASM build tools (wasm-bindgen-cli + wasm32 target)"
script = '''
#!/bin/bash
set -e

echo "Installing WASM build tools..."

# Add wasm32 target
if ! rustup target list --installed | grep -q "wasm32-unknown-unknown"; then
	echo "Adding wasm32-unknown-unknown target..."
	rustup target add wasm32-unknown-unknown
else
	echo "âœ“ wasm32-unknown-unknown target already installed"
fi

# Install wasm-bindgen-cli
if ! command -v wasm-bindgen &> /dev/null; then
	echo "Installing wasm-bindgen-cli..."
	cargo install wasm-bindgen-cli
else
	echo "âœ“ wasm-bindgen-cli already installed"
fi

# Check for wasm-opt (optional, for release optimization)
if ! command -v wasm-opt &> /dev/null; then
	echo ""
	echo "âš ï¸  wasm-opt not found (optional, for release optimization)"
	echo "   Install with: brew install binaryen"
else
	echo "âœ“ wasm-opt available"
fi

echo ""
echo "WASM build tools installed successfully!"
'''

[tasks.wasm-build-dev]
description = "Build WASM in debug mode"
script = '''
#!/bin/bash
set -e

# Find project directory (current or specified)
PROJECT_DIR="${WASM_PROJECT_DIR:-.}"
OUTPUT_DIR="${WASM_OUTPUT_DIR:-dist}"

# Get crate name from Cargo.toml
CRATE_NAME=$(grep -m1 '^name' "$PROJECT_DIR/Cargo.toml" | sed 's/.*"\(.*\)".*/\1/' | tr '-' '_')

echo "Building WASM (debug) for: $CRATE_NAME"

# Build WASM
cargo build --manifest-path "$PROJECT_DIR/Cargo.toml" --target wasm32-unknown-unknown

# Create output directory
mkdir -p "$PROJECT_DIR/$OUTPUT_DIR"

# Run wasm-bindgen
wasm-bindgen \
	--target web \
	--out-dir "$PROJECT_DIR/$OUTPUT_DIR" \
	"$PROJECT_DIR/target/wasm32-unknown-unknown/debug/$CRATE_NAME.wasm"

# Copy index.html if exists
if [ -f "$PROJECT_DIR/index.html" ]; then
	cp "$PROJECT_DIR/index.html" "$PROJECT_DIR/$OUTPUT_DIR/"
fi

echo "âœ“ WASM built successfully: $PROJECT_DIR/$OUTPUT_DIR"
'''

[tasks.wasm-build-release]
description = "Build WASM in release mode with optimization"
script = '''
#!/bin/bash
set -e

# Find project directory (current or specified)
PROJECT_DIR="${WASM_PROJECT_DIR:-.}"
OUTPUT_DIR="${WASM_OUTPUT_DIR:-dist}"

# Get crate name from Cargo.toml
CRATE_NAME=$(grep -m1 '^name' "$PROJECT_DIR/Cargo.toml" | sed 's/.*"\(.*\)".*/\1/' | tr '-' '_')

echo "Building WASM (release) for: $CRATE_NAME"

# Build WASM in release mode
cargo build --manifest-path "$PROJECT_DIR/Cargo.toml" --target wasm32-unknown-unknown --release

# Create output directory
mkdir -p "$PROJECT_DIR/$OUTPUT_DIR"

# Run wasm-bindgen
wasm-bindgen \
	--target web \
	--out-dir "$PROJECT_DIR/$OUTPUT_DIR" \
	"$PROJECT_DIR/target/wasm32-unknown-unknown/release/$CRATE_NAME.wasm"

# Optimize with wasm-opt if available
if command -v wasm-opt &> /dev/null; then
	echo "Running wasm-opt..."
	WASM_FILE="$PROJECT_DIR/$OUTPUT_DIR/${CRATE_NAME}_bg.wasm"
	wasm-opt -O3 -o "$WASM_FILE.opt" "$WASM_FILE"
	mv "$WASM_FILE.opt" "$WASM_FILE"
else
	echo "âš ï¸  wasm-opt not found, skipping optimization"
fi

# Copy index.html if exists
if [ -f "$PROJECT_DIR/index.html" ]; then
	cp "$PROJECT_DIR/index.html" "$PROJECT_DIR/$OUTPUT_DIR/"
fi

echo "âœ“ WASM built successfully: $PROJECT_DIR/$OUTPUT_DIR"
'''

[tasks.wasm-watch]
description = "Watch for changes and rebuild WASM (debug mode)"
command = "bacon"
args = ["wasm-dev"]
dependencies = ["install-bacon"]

[tasks.wasm-clean]
description = "Clean WASM build artifacts"
script = '''
#!/bin/bash
PROJECT_DIR="${WASM_PROJECT_DIR:-.}"
OUTPUT_DIR="${WASM_OUTPUT_DIR:-dist}"

echo "Cleaning WASM artifacts..."
rm -rf "$PROJECT_DIR/$OUTPUT_DIR"
rm -rf "$PROJECT_DIR/target/wasm32-unknown-unknown"
echo "âœ“ Cleaned"
'''

[tasks.wasm-serve]
description = "Serve WASM build with a local HTTP server"
script = '''
#!/bin/bash
PROJECT_DIR="${WASM_PROJECT_DIR:-.}"
OUTPUT_DIR="${WASM_OUTPUT_DIR:-dist}"
PORT="${WASM_SERVE_PORT:-8080}"

# Check if python3 is available
if command -v python3 &> /dev/null; then
	echo "Serving $PROJECT_DIR/$OUTPUT_DIR at http://localhost:$PORT"
	cd "$PROJECT_DIR/$OUTPUT_DIR" && python3 -m http.server $PORT
else
	echo "Error: python3 is required for the HTTP server"
	exit 1
fi
'''

# ============================================================================
# Development Tasks (WASM + Server integrated)
# ============================================================================

[tasks.dev]
description = "Start development server (builds WASM if --with-pages project)"
script = '''
#!/bin/bash
set -e

# Check if this is a WASM project (has index.html and wasm32 target in Cargo.toml)
if [ -f "index.html" ] && grep -q 'crate-type.*cdylib' Cargo.toml 2>/dev/null; then
	echo "ðŸ“¦ Detected WASM project, building frontend..."

	# Build WASM
	cargo make wasm-build-dev

	echo ""
	echo "ðŸš€ Starting development server with WASM frontend..."
	echo ""

	# Start server with --with-pages
	cargo run --bin manage runserver --with-pages
else
	echo "ðŸš€ Starting development server..."
	cargo run --bin manage runserver
fi
'''

[tasks.dev-release]
description = "Start production-like server with optimized WASM"
script = '''
#!/bin/bash
set -e

# Check if this is a WASM project
if [ -f "index.html" ] && grep -q 'crate-type.*cdylib' Cargo.toml 2>/dev/null; then
	echo "ðŸ“¦ Building optimized WASM for production..."

	# Build WASM in release mode
	cargo make wasm-build-release

	echo ""
	echo "ðŸš€ Starting server with optimized WASM frontend..."
	echo ""

	# Start server with --with-pages
	cargo run --release --bin manage runserver --with-pages
else
	echo "ðŸš€ Starting server in release mode..."
	cargo run --release --bin manage runserver
fi
'''

[tasks.dev-watch]
description = "Watch mode: rebuild WASM and restart server on changes"
command = "bacon"
args = ["dev"]
dependencies = ["install-bacon"]
